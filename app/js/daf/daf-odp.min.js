/*!
* Data Aquarium Framework - Offline Data Processor
* Copyright 2017-2018 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function c(n,t){t.forEach(function(t){var i=n[t];t in n&&(i==null||i===!1&&t!="OldValue"||i===""||Array.isArray(i)&&!i.length)&&delete n[t]})}function s(n){return JSON.stringify({d:n})}function l(){return n.offline()||!t.online()}function r(n){var i,t=[];return typeof n=="string"?t.push(n):Array.isArray(n)?t=n:i=n,{Tag:null,Errors:t,Values:[],Canceled:!1,NavigateUrl:null,ClientScript:null,RowsAffected:i||0,Filter:null,SortExpression:null,RowNotFound:!1}}function u(n){return JSON.parse(JSON.stringify(n))}var t=$app,n,a=window,v=2147483647,h=Sys.CultureInfo.CurrentCulture.dateTimeFormat,f=Sys.CultureInfo.CurrentCulture.numberFormat,e,y=[{_m:"GetPage",_r:"request",Me:["SortExpression","FilterIsExternal","LookupContextFieldName","LookupContextController","LookupContextView","LookupContext","Inserting","LastCommandName","DoesNotRequireData","LastView","RequiresFirstLetters","SupportsCaching","SystemFilter","RequiresRowCount","RequiresPivot","PivotDefinitions","Filter","ExternalFilter","SyncKey","Tag"]},{_m:"Execute",_r:"args",Me:["CommandArgument","LastCommandName","LastCommandArgument","SaveLEVs","ContextKey","LastView","Filter","SortExpression","SelectedValues","ExternalFilter"],Values:["OldValue","ReadOnly","Error"]}],o=t.findDataView,p=["None","Sum","Count","Average","Max","Min"],w=["Thumbnail","Link","Signature"],b=["Text","Password","RichText","Note","Static"],k=["Default","Required","Suggested","Allowed","Forbidden"],d=/([\w\,\.]+):([\s\S]*)/,g=/^(_match_|_donotmatch_)\:(\$all\$|\$any\$)$/,nt=/(\*|\$\w+\$|=|~|<(=|>){0,1}|>={0,1})([\s\S]*?)(\0|$)/;n=t.odp={toDataUrl:function(n){return $.when(n)},toOriginalUrl:function(n){return $.when(n+"&_ticks="+(new Date).getTime())},download:function(n){t.touch.openHref(n)},blob:function(t){var r=__baseUrl,s=t.field,u=s.OnDemandHandler,h=t.crop,c=t.format||"t",f=t.key,i=t.image,e=t.link,o=$.Deferred();return t.href=String.format("{0}blob.ashx?{1}=o|{2}",r,u,f),e&&e.attr("data-href",t.href),t.src=String.format("{0}blob.ashx?{1}={4}|{2}{3}",r,u,f,h!=!0?"&_nocrop":"",c),i&&(i.attr("src","data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"),n.toDataUrl(t.src).done(function(n){i.attr("src",n)})),o.resolve(t),o.promise()},enabled:function(i){if(arguments.length&&(this._enabled=i==!0),!this._checkedSettings&&typeof __settings!="undefined"){this._checkedSettings=!0;var r=__settings&&__settings.odp;r&&(r.enabled==!1&&(this._enabled=!1),r.pageSize&&(n._pageSize=r.pageSize))}return t.touch&&this._enabled!=!1},offline:function(){return!1},get:function(n){var r=null,i;return t.touch&&(i=n||t.touch.dataView(),i&&(i._survey&&(i=o(i._survey.parent)),i&&(r=i.odp))),r},start:function(){var t=__settings.odp;n.enabled(t&&t.enabled);n.controllers={};n.functions={};n._pk={};n._sequence=0;n._pendingResponses={};n._cache={}},response:function(t,i){var r=n._pendingResponses;if(!r)return null;if(arguments.length==2)r[t]=i;else return i=r[t],i&&(r[t]=null),i},invoke:function(i,r){function k(){$.ajax(r).done(function(n){e.resolve(n)}).fail(function(n,t,i){e.reject(n,t,i)})}function p(){var n,h,s,c;t.odp.enabled()&&(u=i.odp,u||f!=="GetPage"||(n=i.tagged(/\odp\-enabled\-(\w+)\b/),n=n?n[1]:"auto",n!=="none"&&(i._dataViewFieldParentId?(h=o(i._filterSource),h&&(u=h.odp)):(s=i.get_parentDataView(),s&&(i._filterSource&&(u=s.odp),u||(s.odp?u=s.odp:(u=new t.OfflineDataProcessor(i),u._enabled=n)))),!u&&i._isModal&&(c=$app.touch.dataView(),c&&(u=c.odp))),i.odp=u),u&&u.invoke({method:f,dataView:i,params:r,deferred:e})&&(b=!1))}var nt=this,tt=i.get_servicePath(),f=r.url.substring(tt.length+1),e=$.Deferred(),u,w=n.response(f),l="_"+i._id+"_prefetch",v=a[l],b=!0,s,h;if(v&&f=="GetPage"&&(s=v.innerHTML.replace(/\]\_\[(\/?script.)\]\^\[/gi,"<$1"),h=s.match(/\"TimeStamp\"\:\"ts(\d{4}\-\d{2}\-\d{2}T\d{2}\:\d{2}\:\d{2})\"/),h&&(i.pageProp(l)==h[1]?s=null:i.pageProp(l,h[1])),$(v).remove()),s)p(),e.resolve(s);else if(w)p(),e.resolve(w);else if(y.forEach(function(n){var i,t;if(JSON&&n._m==f)for(i in n)t=r.data,n._r&&(t=t[n._r]),t&&!i.match(/^_/)&&(i!="Me"&&(t=t[i]),t&&(Array.isArray(t)?t.forEach(function(t){c(t,n[i])}):c(t,n[i])))}),p(),b){var it=(f=="GetPage"||f=="Execute")&&!(i._api&&i._api.background),d=location.href,g=t.touch?t.touch.startUrl():d;r.data=t.toAjaxData(r.data);g!=d&&(r.headers||(r.headers={}),r.headers["X-Start-Url"]=g);it?nt.ensureData().then(k):k()}return e.promise()},ensureData:function(){return $.when(!0)},verify:function(n){var i=n.odp,r;i&&(i.root(n)&&i.enabled()?($(n._fields).each(function(){if(this.Type=="DataView")return r=!0,!1}),r||(n.odp=null)):n.get_isForm()&&!n._filterSource&&i.root()!=n&&(n.odp=new t.OfflineDataProcessor(n,i)))},getControllers:function(t){function f(){var n=[];t.forEach(function(t){n.push(r[t])});u.resolve(n)}Array.isArray(t)||(t=[t]);var i=[],u=$.Deferred(),r=n.controllers;return t.forEach(function(n){r[n]||i.push(n)}),i.length?$.ajax({url:__servicePath+"/getcontrollerlist",method:"POST",cache:!1,dataType:"text",data:JSON.stringify({controllers:i})}).done(function(n){var t=JSON.parse(JSON.parse(n).d);t.forEach(function(n){var t=n.dataController,i,u;r[t.name]=t;i=t._map={key:{},fields:{},views:{}};u=t.key=[];t.fields.forEach(function(n){i.fields[n.name]=n;n.isPrimaryKey&&(u.push(n),i.key[n.name]=n)});t.views.forEach(function(n){i.views[n.id]=n})});f()}):f(),u.promise()},commit:function(t){function o(){c.resolve(i);var n=t.deferred;n&&n.resolve(s(i))}var h=t.controller,u=t.odp,f=t.log,c=$.Deferred(),i,e;return f.length?(e=h==f[0].controller,$.ajax({url:__servicePath+"/commit",method:"POST",cache:!1,dataType:"text",data:JSON.stringify({log:f})}).done(function(t){if(t=t?JSON.parse(t).d:{},n._cache={},t.Success){if(u&&u._log.splice(0),i=r(1),e&&f[0].args.CommandName=="Insert"&&t.Values.length){var s=t.Values[0];s.Controller==h&&i.Values.push({Name:s.Name,NewValue:s.Value})}}else e&&u&&u._log.splice(0,1),i=r(t.Errors);o()}).fail(function(){i=r("Unable to save changes.");o()})):o(),c.promise()},func:function(t){var i=n.functions[t];return i||(i=n.functions[t]=eval(t)),i},compare:function(n,t){return n==null?t==null?0:-1:t==null?1:(typeof n=="string"&&(n=n.toUpperCase()),typeof t=="string"&&(t=t.toUpperCase()),n<t)?-1:n>t?1:0},filters:{_regexCache:{},_inrange:function(n,t){return n==t},_like:function(t,i){if(t==null||i==null)return!1;var r=n.filters._regexCache[i],u;return r||(u=i,i.match(/^\%/)?(i=i.substring(1),i.match(/\%$/)?(i=i.substring(0,i.length-1),r=new RegExp(RegExp.escape(i),"i")):r=new RegExp(RegExp.escape(i)+"$","i")):i.match(/\%$/)?(i=i.substring(0,i.length-1),r=new RegExp("^"+RegExp.escape(i),"i")):r=new RegExp("^"+RegExp.escape(i)+"$","i"),n.filters._regexCache[u]=r),typeof t!="string"&&(t=t.toString()),t.match(r)!=null},beginswith:function(n,t){return n==null||t==null?!1:(typeof n!="string"&&(n=n.toString()),typeof t!="string"&&(t=t.toString()),n=n.toUpperCase(),t=t.toUpperCase(),n.indexOf(t)==0)},doesnotbeginwith:function(){return!1},contains:function(){return!1},doesnotcontain:function(){return!1},endswith:function(){return!1},doesnotendwith:function(){return!1},between:function(){return!1},"in":function(n,t){return n==null?!1:(Array.isArray(t)||(t=[t]),t.indexOf(n)!=-1)},notin:function(n,t){return!this.in(n,t)},month1:function(){return!1},month2:function(){return!1},month3:function(){return!1},month4:function(){return!1},month5:function(){return!1},month6:function(){return!1},month7:function(){return!1},month8:function(){return!1},month9:function(){return!1},month10:function(){return!1},month11:function(){return!1},month12:function(){return!1},thismonth:function(){return!1},nextmonth:function(){return!1},lastmonth:function(){return!1},quarter1:function(){return!1},quarter2:function(){return!1},quarter3:function(){return!1},quarter4:function(){return!1},thisquarter:function(){return!1},lastquarter:function(){return!1},nextquarter:function(){return!1},thisyear:function(){return!1},nextyear:function(){return!1},lastyear:function(){return!1},yeartodate:function(){return!1},thisweek:function(){return!1},nextweek:function(){return!1},lastweek:function(){return!1},today:function(){return!1},yesterday:function(){return!1},tomorrow:function(){return!1},yesterday:function(){return!1},past:function(){return!1},future:function(){return!1},"true":function(){return!1},"false":function(){return!1},isempty:function(n){return n==null},isnotempty:function(n){return n!=null}}};t.OfflineDataProcessor=function(t,i){var r=this;r._sequence=n._sequence++;r._date=new Date;r._dataView=t;r._state="inactive";r._data={};r._log=[];r._dataLoadMap={};r._dataLoadedKeys={};r._dataLoadAll={};r._tracking={};r._master=i;i&&(r._dataLoadMap=u(i._dataLoadMap),r._dataLoadedKeys=u(i._dataLoadedKeys),r._dataLoadAll=u(i._dataLoadAll),r._tracking=u(i._tracking))};t.OfflineDataProcessor.prototype={is:function(n){var t=this;if(arguments.length){if(n.match(/^:/))return n==":dirty"?t._log.length>0:t._state==n.substring(1);t._state=n}else return t._state},enabled:function(){return this._enabled!="none"},root:function(n){return arguments.length==1?this._dataView==n:this._dataView},invoke:function(i){function k(n){var r=i.params.data,f=r.args;return f.Date=t.stringifyDate(arguments.length?n:new Date),f.Sequence=u._sequence,r}function d(){c.forEach(function(n){var t=n.args,i=n.controller,r=$.Deferred(),u={deferred:r,method:"Execute",params:{data:n}};t.Sequence=f._sequence;p.push(r.promise());f.tracking(i,!0);t.CommandName=="Insert"?f.execute(u):$.when(f.getData(i,t.ExternalFilter)).done(function(){f.execute(u)})});$.when.apply($,p).done(function(){var n=a?arguments[0]:s(r(1)),t=JSON.parse(n).d;t.Errors.length||(c.forEach(function(n){f._log.push(n)}),i.deferred.resolve(n))})}var u=this,f=u._master,c=u._log,w,h=i.dataView,e=h._controller,b=h._lastArgs,v=b?b.CommandName:"",y=u._dataView,g=y==h,l=i.method,p,a;if(g){if(l=="GetPage"&&h.get_lastCommandName()=="New")u.is("active");else if(l=="Execute"&&v.match(/^(Insert|Update)$/))return a=v=="Insert",c.length||a?(a||i.params.data.args.Values.every(function(n){var t=!0;return n.Modified&&(a=!0,t=!1),t}),a&&c.splice(0,0,k(u._date)),c=JSON.parse(JSON.stringify(c)),f?(f.is("active"),p=[],a?$.when(n.getControllers(e)).done(d):d()):n.commit({log:c,odp:u,controller:e,deferred:i.deferred}),!0):!1}else if(l==="Execute"&&v.match(/^(Insert|Update|Delete)$/))u.is("active"),c.push(k()),u.tracking(e,!0),h._filterSource||u._dataLoadAll[e]!=null||(u._dataLoadAll[e]=!0);else if(l==="GetPage"&&y.inserting()){for(f=h;f&&f._filterSource;)f=o(f._filterSource);f&&f!=h&&f.inserting()&&u.tracking(e,!0)}return l.match(/^(GetPage|Execute|GetListOfValues)$/)&&u.tracking(h)&&($.when(n.getControllers(e)).done(function(){!y.inserting()||l!=="GetPage"||i.params.data.request.ExternalFilter||u._dataLoadAll[e]||(u._dataLoadAll[e]=!0);$.when(u.ensureData(e,l)).done(function(){y.inserting()&&u._dataLoadAll[e]||l==="Execute"&&v==="Insert"?u.execute(i):$.when(u.getData(e,h.get_externalFilter())).done(function(){u.execute(i)})})}),w=!0),!!w},tracking:function(n){typeof n!="string"&&(n=n._controller);var t=this._tracking;if(arguments.length==1)return!!t[n];t[n]=arguments[1]},ensureData:function(n,t){var r=this,i=$.Deferred();return t!="Execute"&&r._dataLoadAll[n]?r.getData(n).done(function(){i.resolve()}):i.resolve(),i.promise()},_borrowData:function(n){var t=this,i=t._master;i&&!t._data[n]&&i._data[n]&&(t._data[n]=u(i._data[n]))},getData:function(i,r){function h(){s=="_all"&&(u._dataLoadAll[i]=!1);var n=u._data[i];l.resolve(n)}function a(e){var s=n._pageSize||100;t.execute({controller:i,view:"offline",pageSize:s,pageIndex:e,requiresRowCount:e==0,externalFilter:r,odp:!1,nativeDates:!1}).done(function(t){var r=t[i];f||(f=n._cache[c]=[]);f.push(JSON.stringify(r));e==0&&(o=t.totalRowCount);u.addData(i,r);o-=s;o<0?h():a(e+1)})}var u=this,l=$.Deferred(),o,s,c,f,e=u._dataLoadMap[i];return u._borrowData(i),e||(e=u._dataLoadMap[i]={}),s=r&&r.length?JSON.stringify(r):"_all",c=i+"$"+s,e._all||e[s]?h():n.offline("hasData")?(e._all=!0,n.offline({controller:i}).then(function(n){u.addData(i,n);h()})):(e[s]=!0,f=n._cache[c],f?(o=0,f.forEach(function(n){n=JSON.parse(n);o+=n.length;u.addData(i,n)}),h()):a(0)),l.promise()},addData:function(t,i){var r=this,e=n.controllers[t].key,u=r._dataLoadedKeys[t],f=r._data[t];u||(u=r._dataLoadedKeys[t]={});f||(f=r._data[t]=[]);i.forEach(function(n){var t=[];e.forEach(function(i){t.push(n[i.name])});t=t.join(",");u[t]||(u[t]=!0,f.push(n))})},execute:function(i){function o(n){i.deferred.resolve(s(n))}var v=this,k=i.method,h=i.params.data,d=h.args,et=h.request,w=d?d.Values:null,rt=n.controllers[h.controller],c=rt.name,y=d?d.CommandName:null,g=rt._map,nt=[],p={},ot=0,tt,u,ut,b,a,e,st,it,f,ft;if(v._borrowData(c),k=="Execute")if(u=r(),ut=y=="Update",deleting=y=="Delete",ut||deleting)w.forEach(function(n){g.key[n.Name]&&(nt.length&&nt.push("&&"),nt.push("(this."+n.Name+"==params.p"+ot+")"),p["p"+ot++]=n.OldValue)}),v.select({from:c,where:{filter:nt.join(""),params:p},limit:deleting?Number.MAX_VALUE:1,remove:deleting}).done(function(n){var t=n[0];t&&ut&&w.forEach(function(n){n.Modified&&(t[n.Name]=n.NewValue)});u.RowsAffected=n.length;u.RowNotFound=n.length==0;o(u)});else if(y=="Insert"){b={};tt=v._data[c];statusField=g.fields.Status;w.forEach(function(n){(n.Name!="Status"||statusField)&&(b[n.Name]=n.NewValue)});tt||(tt=v._data[c]=[]);tt.push(b);u.RowsAffected=1;for(a in g.key)if(b[a]==null){e=n._pk[c];e==null&&(e=n._pk[c]=0);e--;n._pk[c]=e;g.key[a].type.match(/(Guid|String)/)&&(e=e.toString());b[a]=e;u.Values.push({Name:a,Value:e});w.every(function(n){n.Name==a&&(n.NewValue=e,n.Modified=!0,st=n)});st||w.push({Name:a,Value:e,Modified:!0});break}o(u)}else y=="Calculate"?rt.calculateOnServer&&!l()?(p=i.params,p.data=t.toAjaxData(p.data),$.ajax(p).done(function(n){u=JSON.parse(n).d;o(u)}).fail(function(){o(u)})):o(u):y=="PopulateDynamicLookups"?o(u):t.alert("Unsupported command "+y,function(){o(u)});else k=="GetPage"?(it=et,it.Controller=h.controller,it.View=h.view,v._viewPage(it).done(function(n){delete n._fieldMap;delete n._metadataFilter;o(n)})):k=="GetListOfValues"?(f=et,f.Controller=h.controller,f.View=h.view,f.Distinct=!0,f.PageSize=Number.MAX_VALUE,f.PageIndex=0,ft=f.FieldName,f.FieldFilter=[ft],f.MetadataFilter=["fields"],f.DoesNotRequireAggregates=!0,f.SortExpression=ft,v._viewPage(f).done(function(n){var t=[];n.Rows.every(function(n){return t.push(n[0]),t.length<1e3});o(t)})):t.alert("Unknown method: "+k)},select:function(t){var c=this,l=$.Deferred(),f=t.from,e=t.where,a=e?e.filter:null,v=t.sort,u=typeof f=="string"?c._data[f]||[]:f,r=[],o=[],s=t.index?[]:null,y,i,h;if(t.yield)r=t.yield;else{if(a){for(y=n.func("(function(params,rowIndex){return "+a+"})"),i=0;i<u.length;i++)if(h=u[i],y.call(h,e.params,i+1)&&(r.push(h),s&&s.push(i+1),t.remove&&o.push(i),t.limit==r.length))break;for(i=o.length-1;i>=0;i--)u.splice(o[i],1)}else r=u.slice(0);v&&r.sort(n.func(c._sortFunc(v)))}return l.resolve(r,s),l.promise()},key:function(t){var u=[],r=t._controller,i=t.inserting()?t._newRow:t._rows[0];return i&&t._keyFields.forEach(function(t){var e=t.Type,o=t.Index,f;(e!="String"||t.Len==36)&&(f=i[o],f==null&&(f=n._pk[r],f==null&&(f=n._pk[r]=0),f--,n._pk[r]=f,e.match(/(Guid|String)/)&&(f=f.toString()),i[o]=f));u.push(i[t.Index])}),u},_sortFunc:function(n){var t=["(function(a,b){"],u=/(\w+)(\s+(asc|desc))?/ig,i,r=!0;for(t.push("var result=0;");i=u.exec(n);)r?r=!1:t.push("if (result != 0) return result;"),t.push(String.format("result = ($app.odp.compare(a.{0},b.{0}))",i[1])),i[3]&&i[3].match(/^desc/i)&&t.push("if (result != 0) result *=-1;");return t.push("return result;"),t.push("})"),t.join("\n")},_viewPage:function(r){function vt(){u=n.controllers[at];o=rt?u._map.views[rt]:u.views[0]}function yt(n){var t=this;t.PageSize!=1e3||t.SortExpression||(t.SortExpression=n.sortExpression)}function pt(n){var t=this,i,r;t.Tag=n.Tag;t.DistinctValueFieldName=n.FieldName;t.PageOffset=n.PageOffset||0;t.RequiresMetaData=n.PageIndex==-1||n.RequiresMetaData;t.RequiresRowCount=n.PageIndex<0||n.RequiresRowCount;t.PageIndex=0;n.PageIndex==-2&&(n.PageIndex=0);t.PageSize=n.PageSize;n.RequiresPivot&&(t.RequiresPivot=!0,t.RequiresMetaData=!1,t.RequiresRowCount=!1,t.PageSize=Number.MAX_VALUE);n.PageIndex>0&&(t.PageIndex=n.PageIndex);t.Rows=[];t.Fields=[];t.SortExpression=n.SortExpression;t.GroupExpression=n.GroupExpression;t.Filter=n.Filter;t.SystemFilter=n.SystemFilter;t.TotalRowCount=-1;t.Views=[];t.ActionGroups=[];t.Categories=[];t.Controller=n.Controller;t.View=n.View;t.LastView=n.LastView;t.ViewType=n.ViewType;t.SupportsCaching=n.SupportsCaching;t.QuickFindHint=n.QuickFindHint;t.InnerJoinPrimaryKey=n.InnerJoinPrimaryKey;t.InnerJoinForeignKey=n.InnerJoinForeignKey;t.RequiresSiteContentText=n.RequiresSiteContentText;t.FieldFilter=n.FieldFilter;t._metadataFilter=n.MetadataFilter;t.Distinct=n.Distinct;i="Form";r=n.Tag;r&&r.match(/\bview\-type\-inline\-editor\b/)&&(i="Grid");t._staticLookupViewTypeFilter=i}function c(n){var t=this._metadataFilter;return t==null||t.indexOf(n)!=-1}function ut(){var n=this,t=[];return n.Distinct||n.Fields.forEach(function(n){n.IsPrimaryKey&&t.push(n)}),t}function wt(n){var i=this,t=n.Expressions=[];c.call(n,"expressions")&&u.expressions.forEach(function(i){(i.ViewId==null||i.ViewId==n.View)&&t.push(i)})}function ft(n){var t=this,i=t.HeaderText||t.Label||t.Name;return i=i.replace(/\s/g,""),n=new RegExp("^"+RegExp.escape(n.replace(/\s/g,"")),"i"),i.match(n)}function bt(n){var t=o.categories||[];t.forEach(function(t,i){n.Categories.push({Id:t.id,Index:i,HeaderText:t.headerText,Description:t.description?t.description["@value"]:null,Tab:t.tab,Wizard:t.wizard,Flow:t.flow,Wrap:t.wrap==!0,Floating:t.floating==!0,Collapsed:t.collpased==!0})});t.length||n.Categories.push({Id:null,Index:0})}function kt(){}function y(n){var r=n,t,u,i;if(n!=null){for(typeof n=="string"?(t=n.split(/(?:\$(?:and|or)\$)/g),u=t.length>1):t=[n],i=0;i<t.length;i++)n=t[i],n!=null&&n.match(/^%js%/)&&(t[i]=JSON.parse(n.substring(4)));r=u?t:t[0]}return r}function et(n){return n=="null"||n=="%js%null"}function ot(i,r){var o={},c=0,l=r.QuickFindHint,e=!0,s=0,p=!0,a="&&",v=!1,w=r.Filter,u=[];return r.Fields.every(function(n){var t=n.SearchOptions;if(t&&t.match(/\$quickfind(?!disabled)/))return v=!0,!1}),w&&w.forEach(function(i){var pt=i.match(g),ni,ot,ht,wt,ct,bt,st,vt,dt,gt,ut,yt,rt,ui,tt;if(pt&&(ni=pt[1]=="_donotmatch_",ni&&p&&(p=!1,e||u.push(")\n"),s>0&&u.push(")\n"),(!e||s>0)&&u.push("&&\n"),s=0,u.push(" !\n"),e=!0),s==0?(e||u.push(") &&\n"),u.push("(\n")):(u.push(")\n"),u.push("||\n")),a=pt[2]=="$all$"?" && ":" || ",s++,e=!0),ot=i.match(d),ot&&(ht=!0,wt=" || ",ot[2].match(/>\|</)&&(wt=" && "),ct=ot[2].match(nt),ct)){var b=ot[1],w=ct[1],k=ct[3];if(w=="~"&&b=="_quickfind_"&&(b=r.Fields[0].Name),bt=b.match(/,/),st=r._fieldMap[b],(st!=null&&st.AllowQBE!=!1||w=="~")&&(r.DistinctValueFieldName!=st.Name||s>0||w=="~"||r.AllowDistinctFieldInFilter)||bt)if(ht?(e?(u.push("(\n"),e=!1):u.push(a),u.push("("),ht=!1):u.push(wt),bt){var ti=b.substring(0,b.indexOf(",")),fi=b.substring(ti.length+1),ei=ti+i.indexOf(":");kt(fi,r,u,ei)}else if(w=="~"){k=y(k);for(var lt=[],ii=[lt],oi=new RegExp(RegExp.escape(f.NumberGroupSeparator+f.CurrencyGroupSeparator+f.CurrencySymbol),"gi"),si=Unicode.w+RegExp.escape(h.DateSeparator+h.TimeSeparator+f.NumberDecimalSeparator),ri=new RegExp("\\s*(((\")(.+?)\")|((\\')(.+?)\\')|(,|;|(^|\\s+)-)|(["+si+"]+))","gi"),it=ri.exec(k),at=!1;it;)vt=it[1].trim(),vt==","||vt==";"?(lt=[],ii.push(lt),at=!1):vt=="-"?at=!0:(dt="=",it[3]||it[6]||(dt=" "),gt=" ",at&&(gt="-",at=!1),ut=it[4],ut==null&&(ut=it[7]),ut==null&&(ut=it[10]),lt.push(gt+dt+ut)),it=ri.exec(k);yt=!0;ii.forEach(function(n){yt?yt=!1:u.push("||\n");u.push("(\n");var i=!0;n.forEach(function(n){var s=n.charAt(0)=="-",h=n.charAt(1)=="=",w="like",f,a,y,b,p,g,nt;h&&(w="=");f=n.substring(2);y=f.match(/^(.+)\:(.+)$/);y&&(a=y[1],b=!1,r.Fields.every(function(n){if(n.AllowQBE!=!1&&!n.AliasName||!(n.IsPrimaryKey&&n.Hidden&&ft.call(n))){b=!0;return}}),b?f=y[2]:a=null);var tt=Date.tryParseFuzzyDate(f),rt=tt!=null,it=!0,e,k,d=f;d=d.replace(oi,"");k=parseFloat(d);p=!isNaN(k);h||f.match(/%/)||(f="%"+f+"%");i?i=!1:u.push("&&");s&&u.push("!");u.push("(");g=!1;l&&l.match(/^;/)||r.Fields.forEach(function(n){var r=n.SearchOptions,l,y,i;n.AllowQBE==!1||n.AliasName||n.IsPrimaryKey&&n.Hidden&&(!n.Type.match(/^Date/)||rt)||(!a||ft.call(n,a))&&((v||r)&&r.match(/\$quickfinddisabled/)&&(!v||r||!r.match(/\$quickfind/))||(g=!0,e||(e="p"+c++,o[e]=f),h&&p&&(o[e]=k),h&&(!n.Type.match(/String/)&&!p||n.Type.match(/String/)&&p)||(it?it=!1:u.push("||"),n.Type.match(/^Date/)?(l="p"+c++,o[l]=t.stringifyDate(tt),s&&u.push("(",n.Name," != null)&&"),u.push("(",n.Name," = ",l)):(y=!1,w!="="&&n.Type=="String"&&n.Len>0&&n.Len<f.length&&(i=f,i=i.substring(1),n.Len<i.length&&(i=i.substring(0,i.length-1)),i.length>n.Len?y=!0:(nt=e,e="p"+c++,o[e]=i)),s&&u.push("(this.",n.Name,"!= null)&&"),w=="="?u.push("(this.",n.Name,"==","params.",e,")"):u.push("$app.odp.filters._like(this.",n.Name,",","params.",e,")")),nt&&(e=nt))))});l&&l.match(/\;/);g||(s&&l.match(/^\;/)?u.push("1=1"):u.push("1=0"));u.push(")\n")});u.push(")\n")});yt&&u.push("1=1")}else w.match(/^$/)?(rt="p"+c++,k=y(k),o[rt]=k,u.push("($app.odp.filters.",w.substring(w.length-1),"(this.",b,",params.",rt,")")):(rt="p"+c++,o[rt]=y(k),ui=w=="="&&st.Type.match(/^DateTime/)&&k,w=="<>"&et(k)?u.push("this.",b," != null"):w=="="&&et(k)?u.push("this.",b," == null"):(tt=w,w=="*"?tt="_like":ui?tt="_inrange":w=="<>"?w="!=":w=="="&&(w="=="),tt.match(/\$/)&&(tt=tt.substring(1,tt.length-1)),tt in n.filters?u.push("$app.odp.filters.",tt,"(this.",b,",params.",rt,")"):u.push("this.",b,w+"params.",rt)))}ht||u.push(")\n")}),s&&(u.push(")\n"),u.push(")\n"),e=!0),e||u.push(")\n"),{filter:u.join(""),params:o}}function st(n){var t=n.SortExpression||"",i=ut.call(n);return i.forEach(function(n){n.IsPrimaryKey&&(t.length&&(t+=","),t+=n.Name)}),t}function gt(n,t){var i=$.Deferred(),u;if(n.SyncKey==null||!n.SyncKey.length||t.PageSize<0)return i.resolve(t),i.promise();if(ht(t),u=ut.call(t),u.length==n.SyncKey.length){var r=[],f={},e=0;u.forEach(function(t,i){r.length&&r.push("&&");r.push("(this."+t.Name+"==params.p"+e+")");f["p"+e++]=n.SyncKey[i]});a.select({from:t.Controller,where:ot(n,t),sort:st(t)}).done(function(n){a.select({from:n,where:{filter:r.join(""),params:f},index:!0,limit:1}).done(function(r,u){r.length&&(t.PageIndex=Math.floor((u[0]-1)/t.PageSize),t.PageOffset=0);i.resolve(t,n)})})}else i.resolve(t);return i.promise()}function ht(n){ni(n);ti(n);n.SortExpression||(n.SortExpression=o.sortExpression)}function tt(n,t){var i={Name:n.name,Type:n.type},r,u;return t&&(i.Hidden=t==!0),n.length!=null&&(i.Len=n.length),n.label&&(i.Label=n.label),n.isPrimaryKey!=null&&(i.IsPrimaryKey=n.isPrimaryKey==!0),n.readOnly!=null&&(i.ReadOnly=n.readOnly==!0),n.onDemand!=null&&(i.OnDemand=n.onDemand==!0),n.default!=null&&(i.HasDefaultValue=!0),n.allowNulls!=!1&&(i.AllowNulls=!0),n.hidden!=null&&(i.Hidden=n.hidden==!0),n.allowQBE!=null&&(i.AllowQBE=n.allowQBE!=!1),n.allowLEV!=null&&(i.AllowLEV=n.allowLEV==!0),n.allowSorting!=null&&(i.AllowSorting=n.allowSorting!=!1),n.sourceFields!=null&&(i.SourceFields=n.sourceFields),n.onDemandStyle&&(i.OnDemandStyle=w.indexOf(n.onDemandStyle)),n.onDemandHandler&&(i.OnDemandHandler=n.onDemandHandler),n.contextFields&&(i.ContextFields=n.contextFields),n.showInSummary!=null&&(i.ShowInSummary=n.showInSummary),n.htmlEncode!=null&&(i.htmlEncode=n.htmlEncode!=!1),n.calculated!=null&&(i.Calculated=n.calculated),n.causesCalculate!=null&&(i.CausesCalculate=n.causesCalculate==!0),n.isVirtual!=null&&(i.IsVirtual=n.isVirtual==!0),n.configuration&&(i.Configuration=n.configuration["@value"]),n.dataFormatString&&(i.DataFormatString=n.dataFormatString),n.formatOnClient!=null&&(i.FormatOnClient=n.formatOnClient==!0),r=n.items,r&&(r.dataController&&(i.ItemsDataController=r.dataController),r.targetController&&(i.ItemsTargetController=r.targetController)),u=n.dataView,u&&(i.DataViewController=u.controller,i.DataViewId=u.view,i.DataViewFilterFields=u.filterFields,i.AllowQBE=!0,i.AllowSorting=!0,i.Len=0,i.Columns=0,i.HtmlEncode=!0),i}function ni(n){if(!n.Fields.length){var t=o.dataFields,i={};o.categories&&o.categories.length&&(t=[],(o.categories||[]).forEach(function(n,r){(n.dataFields||[]).forEach(function(n){t.push(n);i[n.fieldName]=r})}));t||(t=[]);t.forEach(function(t){var o=u._map.fields[t.fieldName],r,e,s,f;o&&(r=tt(o),t.hidden!=null&&(r.Hidden=t.hidden==!0),t.dataFormatString!=null&&(r.DataFormatString=t.dataFormatString),t.formatOnClient!=null&&(r.FormatOnClient=t.formatOnClient!=!1),t.dataFormatString&&!r.DataFormatString&&(r.DataFormatString=dt.dataFormatString),t.headerText&&(r.HeaderText=t.headerText["@value"]),t.footerText&&(r.FooterText=t.footerText["@value"]),t.toolTip&&(r.toolTip=t.toolTip),t.watermark&&(r.Watermark=t.watermark),t.hyperlinkFormatString&&(r.HyperlinkFormatString=t.hyperlinkFormatString),t.aliasFieldName&&(r.AliasName=t.aliasFieldName),t.tag&&(r.Tag=t.tag),t.AllowQBE!=null&&(r.AllowQBE=t.allowQBE==!0),t.AllowSorting!=null&&(r.AllowSorting=t.allowSorting==!0),i[r.Name]!=null&&(r.CategoryIndex=i[r.Name]),t.columns!=null&&(r.Columns=t.columns),t.rows!=null&&(r.Rows=t.rows),t.textMode!=null&&(r.TextMode=b.indexOf(t.textMode)),t.readOnly!=null&&(r.ReadOnly=t.readOnly),t.aggregate&&(r.Aggregate=p.indexOf(t.aggregate)),t.search&&(r.Tag=(r.Tag?r.Tag+" ":"")+"search-mode-"+k.indexOf(t.search).ToLowerCase()),t.searchOptions&&(r.SearchOptions=t.searchOptions),e=t.items||o.items,e!=null&&(e.dataController&&(r.ItemsDataController=e.dataController),e.dataView&&(r.ItemsDataView=e.dataView),e.dataValueField&&(r.ItemsDataValueField=e.dataValueField),e.dataTextField&&(r.ItemsDataTextField=e.dataTextField),e.style&&(r.ItemsStyle=e.style),e.newDataView&&(r.ItemsNewDataView=e.newDataView),e.targetController&&(r.ItemsTargetController=e.targetController),e.copy&&(r.Copy=e.copy),e.pageSize&&(r.ItemsPageSize=e.pageSize),e.letters!=null&&(r.ItemsLetters=e.letters==!0),s=e.list,s&&s.length&&(r.Items=[],s.forEach(function(n){r.Items.push([n.value,n.text])})),e.autoSelect!=null&&(r.AutoSelect=e.autoSelect==!0),e.searchOnStart!=null&&(r.SearchOnStart=e.searchOnStart==!0),e.description&&(r.ItemsDescription=e.description)),n.Fields.push(r),f=o.dataView,f&&(f.showInSummary!=null&&(r.DataViewShowInSummary=f.showInSummary==!0),f.showActionBar!=null&&(r.DataViewShowActionBar=f.showActionBar!=!1),f.showActionButtons&&(r.DataViewShowActionButtons=f.showActionButtons),f.showDescription!=null&&(r.DataViewShowDescription=!0),f.showViewSelector!=null&&(r.DataViewShowViewSelector=f.showViewSelector!=!1),f.showModalForms!=null&&(r.DataViewShowModalForms=f.showModalForms==!0),f.searchByFirstLetter!=null&&(r.DataViewSearchByFirstLetter=f.searchByFirstLetter==!0),f.searchOnStart!=null&&(r.SearchOnStart=f.searchOnStart==!0),f.pageSize!=null&&(r.DataBViewPageSize=f.pageSize),f.multiSelect&&(r.DataViewMultiSelect=f.multiSelect==!0),f.showPager!=null&&(r.DataViewShowPager=dataVIew.showPager==!0),f.showPageSize!=null&&(r.DataViewShowPageSize=f.showPageSize!=!1),f.showSearchBar!=null&&(r.DataViewShowSearchBar=f.showSearchBar!=!1),f.showQuickFind!=null&&(r.DataViewShowQuickFind=f.showQuickFind!=!1),f.showRowNumber!=null&&(r.DataViewShowRowNumber=f.showRowNumber==!0),f.autoSelectFirstRow!=null&&(r.DataViewAutoSelectFirstRow=f.autoSelectFirstRow==!0),f.autoHighlightFirstRow!=null&&(r.DataViewAutoHighlightFirstRow=f.autoHighlightFirstRow==!0)),n.RequiresPivot)})}}function ti(n){function f(n){typeof n=="string"&&(n=u._map.fields[n]);n&&!r[n.name]&&(i.push(tt(n,!0)),r[n.name]=i[i.length-1])}function h(n,i){if(n)for(var r=t._fieldMapRegex.exec(n);r;)f(r[i]),r=t._fieldMapRegex.exec(n)}var s;u.statusBar&&(n.statusBar=u.startBar);var e=u.fields,i=n.Fields,r=n._fieldMap={};e.length||e.forEach(function(n){i.push(tt(n))});i.forEach(function(n){r[n.Name]=n});e.forEach(function(n){(n.isPrimaryKey||n.hidden)&&!r[n.name]&&f(n)});i.forEach(function(n){var t=n.AliasName,i;t&&(i=r[t],i?i.Hidden=!0:f(t))});s=o.groupExpression;s&&s.split($app._simpleListRegex).forEach(function(n){f(n)});i.forEach(function(n){h(n.Copy,1);h(n.Configuration,2)})}function ii(n,t){if(t.Distinct){for(var i=0;i<t.Fields.length;)t.Fields[i].IsPrimaryKey?t.Fields.splice(i,1):i++;t.Fields.push({Name:"group_count_",Type:"Double"})}}function ri(n,i){var r="",u;return i[n.Name]==null&&(r="null"),u=n.SourceFields.split(t._simpleListRegex),u.forEach(function(n){r.length&&(r+="|");var t=i[n];r+=t==null?"null":t.toString()}),r}function ui(){}function fi(){for(var n=0;n<s.Fields.length;n++)if(s.Fields[n].Aggregate)return!0;return!1}function ei(){var n=$.Deferred();return n.resolve(),n.promise()}function ct(n){var t={Id:n.id,Type:n.type,Label:n.label};return n.headerText&&(t.HeaderText=n.headerText["@value"]),n.group!=null&&(t.Group=n.group),n.tags&&(t.Tags=n.tags),n.showInSelector==!1&&(t.ShowInSelector=!1),t}function oi(n){var t={Id:n.id};return n.commandName&&(t.CommandName=n.commandName),n.commandArgument!=null&&(t.CommandArgument=n.commandArgument),n.headerText&&(t.HeaderText=n.headerText),n.description&&(t.Description=n.description),n.cssClass&&(t.CssClass=n.cssClass),n.confirmation&&(t.Confirmation=n.confirmation),n.notify&&(t.Notify=n.notify),n.whenLastCommandName&&(t.WhenLastCommandName=n.whenLastCommandName),n.whenLastCommandArgument&&(t.WhenLastCommandArgument=n.whenLastCommandArgument),n.causesValidation!=null&&(t.CausesValidation=n.causesValidation!=!1),n.whenKeySelected!=null&&(t.WhenKeySelected=n.whenKeySelected==!0),n.whenTag&&(t.WhenTag=n.whenTag),n.whenHRef&&(t.WhenHRef=n.whenHRef),n.whenView&&(t.WhenView=n.whenView),n.whenClientScript&&(t.WhenClientScript=n.whenClientScript),n.key&&(t.key=n.key),t}function si(n){var t={Id:n.id,Actions:[],Scope:n.scope};return n.headerText&&(t.HeaderText=n.headerText),n.flat==!0&&(t.Flat=!0),n.actionGroup&&n.actionGroup.forEach(function(n){t.Actions.push(oi(n))}),t}function hi(){var n=this,r=n.Fields,i=n.FieldFilter,t;i&&i.length&&(t=[],r.forEach(function(i){(i.IsPrimaryKey||yi.call(n,i.Name))&&t.push(i)}),n.Fields=t,n.FieldFilter=null)}function ci(){var n=this,t=n.ItemsStyle;return n.ItemsDataController&&!(t=="AutoComplete"||t=="Lookup")}function li(t,i){var d=this,v,w,s,f,r,o,y;if(!c("items"))return!1;if(v=ci.call(t),v&&lt.call(d,t),v){if(e)return!0;e=!0;try{if(s=t.ContextFields,s){for(var h=[],b=/(\w+)\s*=\s*(.+?)($|,)/,u=b.match(s),l={};u;){if(f=u[2].match(/^(\'(.+?)\'|(\d+))$/),f)r=l[f[1]],r||(r=l[f[1]]=[]),r.push(f[2]);else if(i&&(i.every(function(n){if(n.Name==u[2])return n.NewValue==null?(i=null,!1):(h.push(u[1]+":=%js%"+JSON.stringify(n.NewValue)),!1)}),!i))return!0;u=b.match(s)}for(fieldName in l){for(r=l[fieldName],o=0;o<r.length-1;o++)r[o]=JSON.stringify(r[o]);r.length==1?h.push(fieldName+":="+r[0]):h.push(fieldName+":$in$"+r.join("$or$"))}w=h}y=null;t.ItemsTargetController||t.ItemsDataView||(y=t.ItemsDataTextField);var p=t.ItemsDataController,g=t.ItemsDataView,k=$.Deferred();return $.when(n.getControllers(p)).done(function(){$.when(a.getData(p)).done(function(){a._viewPage({Controller:p,View:g,PageIndex:0,PageSize:1e3,SortExpression:y,Filter:w,RequiresMetaData:!0,MetadataFilter:["fields"]}).done(function(n){k.resolve(t,n)})})}),k.promise()}finally{e=!1}}return!1}function ai(){var n={},t=this.Fields;for(i=0;i<t.length;i++)n[t[i].Name]=i;return n}function vi(n,i){var o;n.Items||(n.Items=[]);var c=this,u=n.ItemsDataValueField,r=n.ItemsDataTextField,h=n.Items;u||i.Fields.every(function(n){if(n.IsPrimaryKey)return u=n.Name,!1});r||i.Fields.every(function(n){if(n.Type=="String")return r=n.Name,!1});r||(r=i.Fields[0].Name);var f=ai.call(i),s=[f[u],f[r]],e=n.Copy;if(e)for(m=t._fieldMapRegex.exec(e);m;)o=f[m[2]],o!=null&&s.push(o),m=t._fieldMapRegex.exec(e);i.Rows.forEach(function(n){var t=[];s.forEach(function(i){t.push(n[i])});h.push(t)})}function lt(){var n=this}function yi(n){var t=this.FieldFilter;return!t||t.indexOf(n)!=-1}function pi(n){function a(){l.resolve(i)}var l=$.Deferred(),f=[],i=this,r=i.Fields,e,u,h;return i.RequiresMetaData?(c.call(i,"views")&&n.views&&n.views.forEach(function(n){if(!n.virtualViewId){var t=ct(n);i.Views.push(ct(n));t.Id==i.View&&(i.ViewHeaderText=t.HeaderText)}}),c.call(i,"layouts")&&o.layout&&(i.ViewLayout=o.layout["@value"]),c.call(i,"actions")&&n.actions&&n.actions.forEach(function(n){i.ActionGroups.push(si(n))}),c(i,"items")&&(e=[],u=i.NewRow,!u&&i.Rows.length&&(u=i.Rows[0]),u!=null&&r.forEach(function(n,t){e.push({Name:n.Name,Value:u[t]})}),r.forEach(function(n){if(n.ItemsStyle=="CheckBoxList"||n.ItemsTargetController||o.type==i._staticLookupViewTypeFilter){var t=li.call(i,n,e);typeof t!="boolean"&&f.push(t)}}),h=f.length,h&&$.when.apply($,f).done(function(){var n=arguments,t;for(h==1&&(n=[n]),t=0;t<n.length;t++)vi.call(s,n[t][0],n[t][1]);a()}))):(r=[],i.Expressions=null),c.call(i,"fields")?r.forEach(function(n){n.Formula&&delete n.Formula;lt.call(i,n)}):r.splice(0,r.length),i.Filter&&i.Filter.every(function(n,t){var r=n.match(/_match_/);return r&&i.Filter.splice(t),!r}),i.IsAuthenticated=!!t.userName(),f.length||a(),l.promise()}function wi(n){for(var i=this.Fields,t=0;t<i.length;t++)if(i[t].Name==n)return t;return-1}function bi(){function i(t){if(t)for(var i in u._map.fields)field=u._map.fields[i],t&&i in t&&(o[wi.call(n,i)]=t[i]);r.resolve(n)}var r=$.Deferred(),n=this,o=n.NewRow=[],f=n.Controller,e;for(pkFieldName in u._map.key)u._map.fields[pkFieldName].calculated&&(e=!0);return(e||u.newOnServer)&&!l()?t.execute({controller:f,view:n.View,requiresNewRow:!0,odp:!1,nativeDates:!1}).done(function(n){i(n[f][0])}).fail(i):i(),r.promise()}var a=this,s={},it=$.Deferred(),at=r.Controller,u,rt=r.View,o;return vt(),yt.call(r,s),pt.call(s,r),wt.call(u,s),s.RequiresMetaData&&c.call(s,"categories")&&bt(s),gt(r,s).done(function(n,t){ht(n);hi.call(n);ii(r,n);var f=n.SupportsCaching&&n.PageSize!=v,i=n.PageSize*n.PageIndex+n.PageOffset,e=n.PageSize,o=2;f&&i>n.PageSize&&(i-=n.PageSize);f&&(i>n.PageSize&&(o=3),e=n.PageSize*o);a.select({from:n.Controller,where:ot(r,n),sort:st(n),yield:t}).done(function(t){function w(){if(n.Distinct){var t=[],i={};n.Rows.forEach(function(n){var r=n.toString(),u=i[r];u==null?(i[r]=t.length,t.push(n),n[n.length-1]=0):n=t[u];n[n.length-1]++});n.Rows=t}pi.call(n,u).done(function(n){it.resolve(n)})}for(var l,s,f,h,y,p,a,v,c,o=i;o<i+e&&o<t.length;o++){for(l=t[o],s=[],f=0;f<n.Fields.length;f++)h=n.Fields[f],s[f]=l[h.Name],h.SourceFields&&(s[f]=ri(h,l));n.RequiresPivot?ui.call(n,s):n.Rows.push(s)}y=n.RequiresRowCount&&!(r.Inserting||r.DoesNotRequireData);y&&(n.TotalRowCount=t.length);!r.DoesNotRequireAggregates&&fi.call(n)&&(p=n.Aggregates=[],a=[],n.Fields.forEach(function(n,t){n.Aggregate&&a.push({field:n,index:t,map:{},sum:0,count:0,min:null,max:null})}),t.forEach(function(n){a.forEach(function(t){var u=t.field,i=n[u.Name],r;switch(u.Aggregate){case 1:i!=null&&(r=t.sum+=i);break;case 2:i==null||t.map[i]||(r=++t.count,t.map[i]=!0);break;case 3:i!=null&&(t.sum+=i,r=t.sum/++t.count);break;case 4:i!=null&&(t.max==null||t.max<i)&&(r=t.max=i);break;case 5:i!=null&&(t.min==null||t.min>i)&&(r=t.min=i)}r!=null&&(p[t.index]=r)})}));r.RequiresFirstLetters&&n.ViewType!="Form"&&(n.RequiresRowCount?(v={},c=[],letterField=n.Fields[0],t.forEach(function(n){var t=n[letterField.Name],i;t!=null&&(typeof t!="string"&&(t=t.toString()),t.length&&(i=t.substring(0,1),v[i]||(c.push(i),v[i]=!0)))}),c.sort(),n.FirstLetters=c.join(",")):n.FirstLetters="");r.Inserting?bi.call(n).done(w):ei(n).done(w)})}),it.promise()}};$(document).on("starting.app",function(t){t.namespace=="app"&&n.start()})})();